<div class="sidebar-menu">
  <%= link_to root_path, class: "flex items-center gap mbs-4 mis-1" do %>
    <%#= image_tag("logo.png", size: 30) %>
    <h3 class="text-xl">ChopClips</h3>
  <% end %>

  <%# --- WORKSPACE SWITCHER --- %>
  <div contents 
       class="mbe-4"
       data-controller="popover" 
       data-popover-placement-value="bottom-start" 
       data-action="click@window->popover#clickOutside">
    
    <%= button_tag type: "button", 
                   class: "btn sidebar-menu__button workspace-button i-full", 
                   data: { action: "click->popover#toggle", popover_target: "trigger" }, 
                   aria: { haspopup: "true" } do %>
      
      <div class="flex flex-item-no-shrink overflow-hidden rounded-md bg-green-600">
        <div class="flex items-center justify-center font-bold text-sm" style="width: 36px; height: 36px;">
          <%= account_initials(Current.account) %> 
        </div>
      </div>

      <div class="flex flex-col text-start leading-tight overflow-hidden mis-2">
        <span class="overflow-ellipsis font-semibold"><%= Current.account.name %></span>
        <span class="overflow-ellipsis text-xs text-gray-500 capitalize">
          <%= current_role %>
        </span>
      </div>
      
      <span class="icon icon--chevrons-up-down mis-auto text-gray-400" aria-hidden="true"></span>
    <% end %>

    <%# Switcher Popover Content %>
    <%= tag.div popover: true, id: "workspace-switcher-popover", class: "popover", style: "--popover-size: 16rem;", data: { popover_target: "content" } do %>
      <div class="p-2 text-xs font-semibold text-gray-500 uppercase i-full">
        Switch Workspace
      </div>
      
      <div class="menu i-full" role="menu">
        <% Current.user.accounts.each do |account| %>
          <% is_active = account == Current.account %>
          
          <%= link_to switch_account_path(account), 
              data: { turbo_method: :post }, 
              class: "btn menu__item justify-between i-full #{is_active ? 'bg-green-600 text-reversed hover:bg-green-700' : 'hover:bg-shade'}", 
              role: "menuitem" do %>
            
            <div class="flex items-center gap-2">
              <div class="p-1 rounded-md flex items-center justify-center text-xs font-bold w-6 h-6 bg-black text-reversed">
                <%= account_initials(account) %>
              </div>
              <span class="<%= 'font-bold' if is_active %>">
                <%= account.name %>
              </span>
            </div>

            <% if is_active %>
              <span class="icon icon--check text-reversed" aria-hidden="true"></span>
            <% end %>
          <% end %>
        <% end %>

        <hr class="menu__separator my-1" role="separator"/>
        
        <%= link_to new_account_path, class: "btn menu__item", data: { turbo_frame: "modal" } do %>
          <span class="icon icon--plus" aria-hidden="true"></span>
          Create Workspace
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="sidebar-menu__content">
    <%# --- GROUP 1: PLATFORM --- %>
    <div class="sidebar-menu__group">
      <div class="sidebar-menu__group-label">Platform</div>
      <div class="sidebar-menu__items">
        <details <%= 'open' if current_page?(root_path) ? 'open' : '' %>>
          <summary class="btn sidebar-menu__button">
            <span class="icon icon--gallery-vertical-end" aria-hidden="true"></span>
            <span class="overflow-ellipsis">Studio</span>
          </summary>
          <nav class="sidebar-menu__sub">
            <%= link_to "Projects", root_path, 
                  class: "btn sidebar-menu__button", 
                  aria: (current_page?(root_path) ? { current: "page" } : {}) %>
            
            <%= link_to "Brand Kits", "#", 
                  class: "btn sidebar-menu__button" %>
            
            <%= link_to "Templates", "#", 
                  class: "btn sidebar-menu__button" %>
          </nav>
        </details>
      </div>
    </div>

    <%# --- GROUP 2: WORKSPACE SETTINGS --- %>
    <div class="sidebar-menu__group">
      <div class="sidebar-menu__group-label">Configuration</div>
      <div class="sidebar-menu__items">
        
        <%# Check if we are on any settings/members page to keep this open %>
        <% settings_active = request.path.include?('settings') || request.path.include?('members') %>
        
        <details <%= 'open' if settings_active ? 'open' : '' %>>
          <summary class="btn sidebar-menu__button">
            <span class="icon icon--settings" aria-hidden="true"></span>
            <span class="overflow-ellipsis">Workspace Settings</span>
          </summary>
          <nav class="sidebar-menu__sub">
            
            <% if current_role == "Admin" %>
              <%= link_to "General", edit_account_path(Current.account), 
                    class: "btn sidebar-menu__button",
                    aria: (current_page?(edit_account_path(Current.account)) ? { current: "page" } : {}) %>
            <% end %>

            <%= link_to "Teams", members_path, 
                  class: "btn sidebar-menu__button",
                  aria: (current_page?(members_path) ? { current: "page" } : {}) %>

            <% if current_role == "Admin" %>
              <%= link_to "Billing", "#", class: "btn sidebar-menu__button" %>
            <% end %>

            <%= link_to "Limits", "#", class: "btn sidebar-menu__button" %>
          </nav>
        </details>
      </div>
    </div>
  </div>

  <%# --- FOOTER ITEMS --- %>
  <div class="mbs-auto flex flex-col">
     <%# Theme Switcher %>
     <div contents 
         data-controller="popover" 
         data-popover-placement-value="right-center" 
         data-action="click@window->popover#clickOutside">
      <%= button_tag type: "button", class: "btn sidebar-menu__button display-md", data: { action: "click->popover#toggle", popover_target: "trigger" }, aria: { haspopup: "true" } do %>
        <span class="icon icon--sun icon--color-scheme-light" aria-hidden="true"></span>
        <span class="icon icon--moon icon--color-scheme-dark" aria-hidden="true"></span>
        <span class="sr-only">Theme switcher</span>
        Theme
      <% end %>
      <%= tag.div popover: true, id: "dashboard-theme-switcher-popover", class: "popover", style: "--popover-size: 12rem;", data: { popover_target: "content" } do %>
        <div class="menu" data-controller="menu" data-action="keydown->menu#navigate" role="menu">
          <button type="button" class="btn menu__item" data-action="popover#hide color-scheme#setLight" data-menu-target="item" role="menuitem">Light</button>
          <button type="button" class="btn menu__item" data-action="popover#hide color-scheme#setDark" data-menu-target="item" role="menuitem">Dark</button>
          <button type="button" class="btn menu__item" data-action="popover#hide color-scheme#setSystem" data-menu-target="item" role="menuitem">System</button>
        </div>
      <% end %>
    </div>

    <%# Notifications Popover (Sidebar Version) %>
    <div contents
     data-controller="popover" 
     data-popover-placement-value="right-center" 
     data-action="click@window->popover#clickOutside">
  
      <%= button_tag type: "button", 
                    class: "btn sidebar-menu__button mbe-1 display-md", 
                    data: { action: "click->popover#toggle", popover_target: "trigger" } do %>
        <div class="relative">
          <span class="icon icon--bell" aria-hidden="true"></span>
          <%# Pass explicit ID suffix for sidebar %>
          <%= render "notifications/badge", unread: current_user.notifications.unread.any?, id_suffix: "sidebar" %>
        </div>
        Notifications
      <% end %>

      <%= tag.div popover: true, id: "notifications-popover", class: "popover", style: "--popover-size: 29rem;", data: { popover_target: "content" } do %>
        <%# Unique ID for Sidebar List %>
        <div class="popover__scrollable-list" id="sidebar-notifications-list">
          <%= render partial: "notifications/notification", collection: current_user.notifications.newest_first.limit(10) %>
          
          <% if current_user.notifications.empty? %>
            <div class="p-4 text-center text-subtle text-sm">No notifications.</div>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# User Profile Popover %>
    <div contents 
         data-controller="popover" 
         data-popover-placement-value="right-start" 
         data-action="click@window->popover#clickOutside">
      <%= button_tag type: "button", class: "btn sidebar-menu__button display-md", data: { action: "click->popover#toggle", popover_target: "trigger" }, aria: { haspopup: "true" } do %>
        <div class="flex shrink-0 overflow-hidden rounded-full">
          <div class="bg-black rounded-full flex items-center justify-center text-lg font-semibold text-reversed" style="block-size: 2.5rem; inline-size: 2.5rem;">
            <%= current_user.initials %>
          </div>
        </div>
        <div class="flex flex-col text-start leading-tight overflow-hidden">
          <span class="inline-flex items-center gap-2 overflow-ellipsis max-i-full font-semibold">
            <span><%= current_user.full_name %></span>
            <% if current_user.verified? %>
              <span class="text-positive" title="Verified Account">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="green" aria-hidden="true">
                  <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
                </svg>
              </span>
            <% end %>
          </span>
          <span class="overflow-ellipsis max-i-full text-xs"><%= current_user.email %></span>
        </div>
        <span class="icon icon--chevrons-up-down mis-auto" aria-hidden="true"></span>
      <% end %>
      
      <%= tag.div popover: true, id: "user-menu-popover", class: "popover overflow-hidden", style: "--popover-size: 15rem;", data: { popover_target: "content" } do %>
        <div class="p-2">
          <%= render "layouts/shared/credits_card" %>
        </div>
        <hr class="menu__separator" role="separator"/>
        <div class="menu" data-controller="menu" data-action="keydown->menu#navigate" role="menu">
          <%= link_to settings_path, class: "btn menu__item", data: { menu_target: "item" }, role: "menuitem" do %>
            <span class="icon icon--user" aria-hidden="true"></span>
            My Profile
          <% end %>
          <%= button_to Current.session, class: "btn menu__item i-full", method: :delete, role: "menuitem" do %>
            <span class="icon icon--log-out" aria-hidden="true"></span>
            Log out
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="hide@md">
      <%= render "layouts/shared/credits_card" %>
    </div>
  </div>
</div>